<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.0/rng/docbook.rng" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://docbook.org/xml/5.0/rng/docbook.rng" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<appendix xmlns="http://docbook.org/ns/docbook" 
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"  xml:id="appendix.configuring-the-daemon">
    <title>Configuring the daemon</title>
    <para>There are a few principle areas which can be used to configure the daemon. They
        are:</para>
    <para>
        <orderedlist>
            <listitem>
                <para>The configuration file (<filename>/etc/g7ctrl/g7ctrl.conf</filename>) which
                    holds all user configurable settings for the daemon itself.</para>
            </listitem>
            <listitem>
                <para>The mail-templates which controls the look and feel of the mail sent from the
                    daemon. They are located in
                    (<filename>/usr/share/g7ctrl/mail_templates</filename>)</para>
            </listitem>
            <listitem>
                <para>Event-scripts. These are shell scripts that the daemon will run on defined
                    events (such as a movement alarm)</para>
            </listitem>
        </orderedlist>
    </para>
    <para>The three areas in the configuration file are described in this appendix.</para>
<section>
    <title>The configuration file</title>
    <para>The following section describes all possible settings in the configuration file. By
            default this is located in "<filename>/etc/g7ctrl/g7ctrl.conf</filename>". The
            configuration file has two main sections, the <literal>[config]</literal> and the
                <literal>[mail]</literal> section. The first section controls all general settings
            and the latter the mail settings such as what <acronym>SMTP</acronym> server to
            use.</para>
    <section xml:id="config-section.startup">
            <title><literal>[startup]</literal> section</title>
            <para>This section will only be read at startup. Any config file re-reads while the
                daemon is running (by sending the SIGHUP signal to the daemon) will ignore settings
                in this section</para>
            <variablelist>
                <varlistentry>
                    <term><literal>run_as_user</literal></term>
                    <listitem>
                        <para>Type: <parameter>string</parameter> (Default:
                                <literal>"g7ctrl"</literal>)</para>
                        <para>Specifies the user who runs the daemon. This has only affect if the
                            daemon is started as root. As soon as the daemon do not need root
                            privileges it will drop down to this user. <emphasis role="bold">Please
                                note that this user must exist on your server</emphasis>. The user
                            should also have access to the serial ports which usually requires the
                            user to belong to the group "<literal>dialout</literal>" since in
                            ancient traditional times serial ports was used for modem
                            connections.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><literal>device_port</literal></term>
                    <listitem>
                        <para>Type: <parameter>integer[1025:60000]</parameter> (Default:
                                <literal>3400</literal>)</para>
                        <para>The port the daemon is listening on for incoming events from the
                            tracker</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term><literal>cmd_port</literal></term>
                    <listitem>
                        <para>Type: <parameter>integer[1025:60000]</parameter> (Default:
                                <literal>3100</literal>)</para>
                        <para>The port the daemon is listening on for commands on. This is the port
                            that the command shell "g7sh" will connect on. It is also perfectly
                            possible to connect directly to this port if one wants to (for some
                            reason) avoid to use the command shelll. </para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
    <section xml:id="config-section.config">
            <title><literal>[config]</literal> section</title>
            <para>Please note that many of these settings can be overridden by supplying command
                line arguments when starting the daemon.</para>
            <para>
                <variablelist>
                    <varlistentry>
                        <term><literal>stty_device</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[0.7]</parameter> (Default: 0)</para>
                            <para>Which virtual serial port to use for connection with tracker over
                                USB. Normally the tracker will appear as an "<emphasis>Abstract
                                    Control Model</emphasis>" tty port numbered from 0
                                    (<literal>ttyACM0</literal> = 0, <literal>ttyACM1</literal> = 1,
                                    <literal>ttyACM2</literal> = 2 ... and so on) . Default is to
                                accept command connection on <literal>ttyACMO0</literal> (i.e.
                                    <literal>stty_device= 0</literal>) </para>
                            <para>If you are unsure of which serial port to use please list the
                                    "<filename>/dev</filename>" directory before and after you
                                connect a tracker device. If your system is reasonable configured
                                your device should show up as "<literal>ttyACM&lt;n></literal>"
                                where "<literal>&lt;n></literal>" is single digit number. </para>
                            <para><emphasis>If your device shows up as something completely
                                    different then unfortunately this version of the daemon does not
                                    support your system, Please report this to have it addressed in
                                    a future version.</emphasis></para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>max_clients</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[10:500]</parameter> (Default:
                                    <literal>50</literal>)</para>
                            <para>The maximum number of clients allowed to connect to the server.
                                All connections will be counted, both command and trackers. As a
                                rule of thumb this should be a minimum of (number of command clients
                                expected) + 3*(number of expected trackers). This can safely be set
                                to a fairly huge number since it means very little system drain to
                                have this as a high number. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>enable_raw_device_commands </literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>false</literal>)</para>
                            <para>Set this to true if you want to allow clients to write raw device
                                commands directly to a connected device. All raw commands follow the
                                normal device command sequence and starts with a
                                    "<literal>$WP+</literal>" prefix. See the GM7 protocol
                                specification for detailed information on each command.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>verbose_log</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[1.3]</parameter> (Default:
                                    <literal>2</literal>)</para>
                            <para>verbosity of logging, 1=only show warning messages, 2=show
                                warnings+information, 3=same as 2 but also show debugging
                                messages.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>client_idle_time</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[10:500]</parameter> (Default:
                                    <literal>1200</literal>)</para>
                            <para>How long time in seconds a command client can be inactive before
                                the connection is closed.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>device_idle_time</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[10:500]</parameter> (Default:
                                    <literal>180</literal>)</para>
                            <para>How long time in seconds the device can be silent before the
                                daemon disconnects. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>require_client_pwd</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>true</literal>)</para>
                            <para>Should the daemon request a password before accepting a command
                                connection</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>client_pwd</literal></term>
                        <listitem>
                            <para>Type: <parameter>string</parameter> (Default:
                                    &lt;<emphasis>generated-at-config-time</emphasis>>)</para>
                            <para>If passwords are enabled this specifies the password to use. A
                                random default value is automatically generated when you configure
                                the source in preparation for compilation (i.e. ./configure)</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>track_split_time</literal></term>
                        <listitem>
                            <para>Type: <literal>integer[10, 24*60]</literal> (Default:
                                    <literal>240</literal>)</para>
                            <para>For <acronym>GPX</acronym> export the locations can be split into
                                different tracks, and track segment if there is a specified time
                                difference between two consecutive location updates. This parameter
                                specifies the minimum time between two locations (in minutes) to
                                consider them to be part of different tracks. Set to -1 to disable.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>trackseg_split_time</literal></term>
                        <listitem>
                            <para>Type: <literal>integer[10, 24*60]</literal> (Default:
                                    <literal>-1</literal>)</para>
                            <para>Within each track the locations can further be divided in track
                                segments for <acronym>GPX</acronym> export. This parameter defines
                                the minimum time between two location update (in minutes) to
                                consider them to be different segments. Set to -1 to disable segment
                                splitting. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>attachment_compression</literal></term>
                        <listitem>
                            <para>Type: <literal>string</literal> (Default:
                                <literal>"xz"</literal>)</para>
                            <para>Specify the program and argument to use for compressing the export
                                attachment file when sending this a mail. On Linux system the "xz"
                                compression is typically the best alternative (highest compression
                                ratio) but requires more memory than for example "gzip". </para>
                            <para>Possible alternatives are: "<command>xz</command>",
                                    "<command>gzip</command>" and "<command>bzip2</command>".</para>
                            <para>Note that it is possible to supply compression level arguments as
                                well, e.g. "<command>xz -8</command>"</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>translate_device_reply</literal></term>
                        <listitem>
                            <para>Type: <literal>bool</literal> (Default:
                                <literal>yes</literal>)</para>
                            <para>Determines if the device reply should also be translated into
                                plain-text in addition to the raw device reply.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>enable_gfen_tracking</literal></term>
                        <listitem>
                            <para>Type: <literal>bool</literal> (Default:
                                <literal>yes</literal>)</para>
                            <para>If the server receives a virtual fence crossing event (GFEN) the
                                if this flag is set the server will put the device in tracking mode.
                                The use case for this behaviour is that GFEN is most often used as a
                                theft alarm when for example a vehicle is moved. If such an event is
                                detected then it is useful to have the device start tracking in
                                order to trace the thieves. This makes it possible to have the
                                tracking normally turned off and only enable it in case of an active
                                theft (and hence save some battery and bandwidth)</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>gfen_tracking_interval</literal></term>
                        <listitem>
                            <para>Type: <literal>integer[10,3600] </literal>(Default:
                                    <literal>90</literal>)</para>
                            <para>The tracking interval in seconds to be used when the automatic
                                tracking after a GFEN event has been enabled.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>mail_on_tracker_conn</literal></term>
                        <listitem>
                            <para>Type: <literal>bool</literal> (Default:
                                <literal>no</literal>)</para>
                            <para>Determines if a mail should be sent when a new tracker connection
                                is established. The mail template used is
                                    "<filename>mail_tracker_conn</filename>". Typically this is used
                                as an alarm when a tracker wakes up and connects to the
                                server.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>script_on_tracker_conn</literal></term>
                        <listitem>
                            <para>Type: <literal>bool</literal> (Default:
                                <literal>no</literal>)</para>
                            <para>Determines if a script should be run when a new tracker connection
                                is established. The script template used is
                                    "<filename>tracker_conn.sh</filename>"</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>use_address_lookup</literal></term>
                        <listitem>
                            <para>Type: <literal>bool</literal> (Default:
                                <literal>no</literal>)</para>
                            <para>Determines if the dameon should do a reverse address lookup from
                                the coordinates and include them in the DB and mail. This uses the
                                Google Map API and might not be available for all locations. In
                                order to reduce the load (and potential future cost) the cached
                                addresses are stored in a file if the daemon is shut down and
                                re-read upon starting up again.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>address_lookup_proximity</literal></term>
                        <listitem>
                            <para>Type: <literal>int</literal> (Default:
                                <literal>20</literal>)</para>
                            <para>Determines how close (in meters) a lookup in the address cache
                                should be to be considered a hit when we search with given
                                coordinates.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>google_api_key</literal></term>
                        <listitem>
                            <para>Type: <literal>string</literal> (Default:
                                <literal>""</literal>)</para>
                            <para>A google <acronym>API</acronym> key to use with Reverse geocoding
                                lookup if tracking or higher bandwidth usage is needed. Anonymous
                                calls are restricted to 2500 calls per 24h and a maximum of 5 calls
                                per second (QPS) on average (as per jan 2015) . For more information
                                on the Google API keys see <xref linkend="section.google-api-key"
                                /></para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </para>
        </section>
    <section xml:id="config-section.report">
            <title><literal>[report]</literal> section</title>
            <variablelist>
                <varlistentry>
                    <term><literal>geoevent_newpage</literal></term>
                    <listitem>
                        <para>Type: <literal>boolean</literal> (Default:
                            <literal>"no"</literal>)</para>
                        <para>Start the Geo-fence event tables on a new page at the end of the
                            report. If this is "no" then the Geo-fence event tables will start
                            directly after the last table in the report.</para>
                    </listitem>
                </varlistentry>
                
                <varlistentry>
                    <term><literal>geoevent_hide_empty</literal></term>
                    <listitem>
                        <para>Type: <literal>boolean</literal> (Default:
                            <literal>"yes"</literal>)</para>
                        <para>If set to "yes" then Geo-fence events which are empty will not be
                            included in the report. </para>
                    </listitem>
                </varlistentry>

                <varlistentry>
                    <term><literal>dir</literal></term>
                    <listitem>
                        <para>Type: <literal>string</literal> (Default:
                            <literal>"/tmp"</literal>)</para>
                        <para>The directory where the report will be written</para>
                    </listitem>
                </varlistentry>
                

            </variablelist>
        </section>
    <section xml:id="config-section.mail">
            <title><literal>[mail]</literal> section</title>
            <para>
                <variablelist>
                    <varlistentry>
                        <term><literal>enable_mail</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>false</literal>)</para>
                            <para>Master switch to enable/disable mail functionlity.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>subject_prefix</literal></term>
                        <listitem>
                            <para>Type: <parameter>string</parameter> (Default: <literal>"GM7
                                    Daemon: "</literal>)</para>
                            <para>The prefix used in the subject header for all mails sent from the
                                daemon. Note: Should include an ending space if separation from the
                                rest of the subject (that depends on the type of mail) is
                                wanted.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>sendmail_on_event</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>false</literal>)</para>
                            <para>Should mails be sent on alarm events. Enabling this will make the
                                daemon send mail on all received events <emphasis role="bold"
                                    >except</emphasis> from normal position updates either requested
                                by the user or when tracking is enabled.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>sendmail_address</literal></term>
                        <listitem>
                            <para>Type: <parameter>string[mail-address]</parameter> (Default:
                                    <literal>root@localhost</literal>)</para>
                            <para>Default address where the mails will be sent to.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>daemon_email_from</literal></term>
                        <listitem>
                            <para>Type: <parameter>string[mail-address]</parameter> (Default:
                                    <literal>&lt;empty></literal>)</para>
                            <para>The from address used i the mail. Please note that this must be a
                                real verifiable mail address. It is not enough to name this (for
                                example) <literal>root@localhost</literal>. Most mail relays will
                                rejected such mails. The only exception would be if the
                                sendmail_address is a local server bound address on the same server
                                running the <acronym>SMTP</acronym> server. In that case the mail
                                will never be routed to an outside mail server. However, if you are
                                not an expert on how the <acronym>SMTP</acronym> server is setup you
                                should probably give a real mail address here to avoid
                                problems!</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>smtp_use</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>false</literal>)</para>
                            <para>Mail can be sent either through a proper <acronym>SMTP</acronym>
                                server or using the local "mail" command. In the latter case only
                                text-mails can be sent (no <acronym>HTML</acronym> mails). To use an
                                    <acronym>SMTP</acronym> server (the recommended way) this master
                                switch must be true.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>smtp_server</literal></term>
                        <listitem>
                            <para>Type: <parameter>string[IP-address]</parameter> (Default:
                                    <literal>localhost</literal>)</para>
                            <para>The IP address of the <acronym>SMTP</acronym> server.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>smtp_port</literal></term>
                        <listitem>
                            <para>Type: <parameter>integer[1:1024]</parameter> (Default:
                                    <literal>-1</literal>)</para>
                            <para>The <acronym>SMTP</acronym> port the server is listening on for
                                incoming connection. By default this is on most server port=25 but
                                more and more this is changed to another port to make it harder for
                                various bot-nets. Please consult your <acronym>SMTP</acronym>
                                provider to find out what port to use. Using a value of "-1" will
                                make the daemon use the system default value for the port.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>smtp_user</literal></term>
                        <listitem>
                            <para>Type: <parameter>string</parameter> (Default:
                                    <literal>&lt;empty></literal>)</para>
                            <para>The user to authenticate on the <acronym>SMTP</acronym>
                                server</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>smtp_pwd</literal></term>
                        <listitem>
                            <para>Type: <parameter>string</parameter> (Default:
                                    <literal>&lt;empty></literal>)</para>
                            <para>The password to authenticate on the <acronym>SMTP</acronym>
                                server</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>use_html</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>true</literal>)</para>
                            <para>Mail can be sent in plain format or in <acronym>HTML</acronym>.
                                This switch must be true to send mail as <acronym>HTML</acronym>
                                (recommended).</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>force_mail_on_all_events</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                    <literal>false</literal>)</para>
                            <para>Mail is not normally sent for <literal>GETLOCATION</literal> or
                                    <literal>TRACK</literal> events. Setting this flag to true will
                                cause mails to be sent even for those two events. Note: Mails will
                                never be sent for <literal>REC</literal> events regardless the
                                setting of this flag.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>include_minimap=no</literal></term>
                        <listitem>
                            <para>Type: <parameter>bool</parameter> (Default:
                                <literal>no</literal>)</para>
                            <para>Determine if the event mail should include two static miniaps
                                displaying the current coordinates with an overview and detailed
                                map.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>minimap_overview_zoom</literal></term>
                        <listitem>
                            <para>Type: <parameter>int</parameter> (Default:
                                <literal>9</literal>)</para>
                            <para>The zoom factor to be used for the overview map</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>minimap_detailed_zoom</literal></term>
                        <listitem>
                            <para>Type: <parameter>int</parameter> (Default:
                                <literal>15</literal>)</para>
                            <para>The zoom factor to be used for the detailed map</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>minimap_width</literal></term>
                        <listitem>
                            <para>Type: <parameter>int</parameter> (Default:
                                <literal>200</literal>)</para>
                            <para>The width of the minimap</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term><literal>minimap_height</literal></term>
                        <listitem>
                            <para>Type: <parameter>int</parameter> (Default:
                                <literal>200</literal>)</para>
                            <para>The height of the minimap</para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </para>
        </section>
    <section>
        <title>The distributed configuration template file </title>
        <para>The values in the configuration file shipped corresponds to default values used if a
                setting is missing or commented.</para>
        <para>
            <programlisting><include xmlns="http://www.w3.org/2001/XInclude" parse="text" href="../../src/etc/g7ctrl.conf.template.in"/>
            </programlisting>
        </para>
    </section>
 </section>
    <section xml:id="section.google-api-key">
        <title>Creating and using a Google API key</title>
        <para>The daemon can make use of two Google map services. First it can be instructed  to
            translate a received location to an approximate address and secondly it can be
            instructed to include two minature static maps (as images) in the event notification
            mail. By default the calls are made anonymously to Google and Googlewill then use the
            sending IP address to track usage and limits. The number of calls and the rate of calls
            (number of calls per second) are limited as decribed in Googles information page (see
            <link xlink:href="https://developers.google.com/maps/documentation/geocoding/"
                >Geocoding API</link>) .  In order to track the usage and possible increase the
            limits it is necessary to create a Google API key. Please note that there are both a
            free Google API key as well as commercial API keys. The usage limits are (of course)
            higher for commercial keys.</para>
        <para>This section only very briefly gives the bare bones information about Google API keys.
            For a complete discussion we refer to Googles own documentation (see <link
                xlink:href="https://console.developers.google.com/"/> )</para>
        <para>
            <important>
                <para>While Google at the moment allows for anonymous calls they clearly state that
                    the preferred way is to use the APIs with a valid API key. Google may at anytime
                    withdraw the anonymous access and an API key will be required. It is therefore
                    recommended to create an API key (a free API key can be created at no
                    charge)</para>
            </important>
        </para>
        <para>The limits with and without keys are as follows:</para>
        <para>
            <table frame="topbot">
                <title>Google rate limits for anonymous geocoding API Calls</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="265pt"/>
                    <colspec colname="c2" colnum="2" colwidth="120pt"/>
                    <thead>
                        <row>
                            <entry>Type of limit</entry>
                            <entry>Limit</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Calls per second</entry>
                            <entry>5 QPS</entry>
                        </row>
                        <row>
                            <entry>Number of calls per 24 h</entry>
                            <entry>2500</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
        <para>
            <table frame="topbot">
                <title>Google rate limits with a valid geocoding API key</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="265pt"/>
                    <colspec colname="c2" colnum="2" colwidth="120pt"/>
                    <thead>
                        <row>
                            <entry>Type of limit</entry>
                            <entry>Limit</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Calls per second</entry>
                            <entry>5 QPS</entry>
                        </row>
                        <row>
                            <entry>Number of calls per 24 h</entry>
                            <entry>2500</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
        <para>In order to increase these limits it is necessary to purchase a commercial API key.
            The API key is then entered in the configuration file. For commercial keys (requires
            billing information) the limits are</para>
        <para>
            <table frame="topbot">
                <title>Google rate limits with billing information geocoding API key</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="265pt"/>
                    <colspec colname="c2" colnum="2" colwidth="120pt"/>
                    <thead>
                        <row>
                            <entry>Type of limit</entry>
                            <entry>Limit</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Calls per second</entry>
                            <entry>10 QPS</entry>
                        </row>
                        <row>
                            <entry>Number of calls per 24 h</entry>
                            <entry>100,000</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            
        </para>
        <para>
            <table frame="topbot">
                <title>Google rate limits for Static Maps with either free API key or anonymous call</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="265pt"/>
                    <colspec colname="c2" colnum="2" colwidth="120pt"/>
                    <thead>
                        <row>
                            <entry>Type of limit</entry>
                            <entry>Limit</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Calls per second</entry>
                            <entry>5 QPS</entry>
                        </row>
                        <row>
                            <entry>Number of calls per 24 h</entry>
                            <entry>25,000</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            
        </para>        
        <para>To either get a developer API key (free of charge - but the same limits as anonymous
            calls) or purchase a commercial key it is necessary to first get a Google account. A
            simplified instruction on how to get a Google API key can be found below. However it is
            strongly recommended you familiarize yourself with the developer console. From the
            console it is possible to see usage statics for the key as well as quota left. For more
            information on keys and developer console please refer to <link
                xlink:href="https://developers.google.com/console/help/new/"> Google Developers Console Help</link></para>
        <para><emphasis role="bold">How to create a Google developer API key</emphasis></para>
        <para>
            <orderedlist>
                <listitem>
                    <para>Login to Google using your Google account.</para>
                </listitem>
                <listitem>
                    <para>Go to the <link
                        xlink:href="https://console.developers.google.com/project"
                        >Developers Console</link></para>
                </listitem>
                <listitem>
                    <para>Create a new project</para>
                </listitem>
                <listitem>
                    <para>When the project has been created a dashboard of options are now
                        displayed. Click on "<literal>Enable an API</literal>" and search in the
                        list for "<literal>Geocoding API</literal>" and enable it.</para>
                </listitem>
                <listitem>
                    <para>Click "<literal>Credentials</literal>" in the left panel and click on
                        "<literal>Create new Key</literal>" button</para>
                </listitem>
                <listitem>
                    <para>Adjust any restrictions on the key (for example which servers are allowed
                        to send requests using this key)</para>
                </listitem>
            </orderedlist>
        </para>
        <para>After the key has been created then the APIs allowed with this key must be enabled. In
            order to use the Geolocation lookup and the static maps the following APIs must be
            enabled</para>
        <para>
            <itemizedlist>
                <listitem>
                    <para><emphasis role="bold">Geocoding API</emphasis> (for address lookup)</para>
                </listitem>
                <listitem>
                    <para><emphasis role="bold">Static Maps API </emphasis>(for minimaps in
                        mail)</para>
                </listitem>
            </itemizedlist>
        </para>
        <para>The detailed on how to enable the specific APIs dependes on if the new or old Google
            console web inetrface is used and is not further discussed here.</para>
        <para>
            <note>
                <para>For the static map lookup the rates are much higher (at the time of writing
                    25,000 static maps per 24/h limited by 5 QPS). However Google states that if
                    they see a continues use for more than 90 days of the maximum level they will
                    get in touch to discuss commercial options.</para>
            </note>
        </para>
    </section>
    
    <section xml:id="section.mail-templates">
        <title>Mail templates</title>
        <para>As of version 2.1.0 there are three possibilities to send mails from the
            daemon.</para>
        <para>
            <orderedlist>
                <listitem>
                    <para>when the daemon receives an event from the tracker that is not a normal
                        track event or the reply from a user requested location. In all other
                        instances when the daemon receives an event an email will be generated. See
                        also the config setting for
                        <literal>force_mail_on_all_events</literal>.</para>
                </listitem>
                <listitem>
                    <para>when the user requests a mail with a exported and compressed version of
                        the tracking database</para>
                </listitem>
                <listitem>
                    <para>when the user requests a mail with the last stored location in the
                        tracking database</para>
                </listitem>
            </orderedlist>
        </para>
        <para>For each of these possibilities the mail sent is based on a template. The mail
            templates are stored in the config directory (normally
                <filename>/usr/share/g7ctrl/mail_templates</filename>) . There are always two versions of
            each template one <acronym>HTML</acronym> version and one plain text version. When an
                <acronym>HTML</acronym> mail is sent the plain text version is also included as
            alternative content in case the end recipient mail client cannot interpret
                <acronym>HTML</acronym>. Also if the configuration setting used
                "<literal>use_html</literal>" is false only plain text mail will be sent.</para>
        <para>
            <note>
                <para>By default no mail will be sent on event 0, 1 or 2. This can however be
                    overridden in the configuration file with the
                        <literal>force_mail_on_all_event</literal> flag. For a list of event please
                    see <xref linkend="section.event-scripts"/>.</para>
            </note>
        </para>
        <para>Each template is an ordinary file in either <acronym>HTML</acronym> or plain text.
            Placeholder in the text will be replaced by the actual data when the mail are sent. The
            following keywords will be replaced in the templates.</para>
        <para>
            <table>
                <title>Mail keywords</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="0.5*"/>
                    <colspec colname="c2" colnum="2" colwidth="1*"/>
                    <thead>
                        <row>
                            <entry>Keyword</entry>
                            <entry>Meaning</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry><literal>[EVENTDESC]</literal></entry>
                            <entry>Description of event</entry>
                        </row>
                        <row>
                            <entry><literal>[EVENTCMD]</literal></entry>
                            <entry>Device command related to the event</entry>
                        </row>
                        <row>
                            <entry><literal>[DATETIME]</literal></entry>
                            <entry>The date and time of the event</entry>
                        </row>
                        <row>
                            <entry><literal>[LAT]</literal></entry>
                            <entry>Latitude at event</entry>
                        </row>
                        <row>
                            <entry><literal>[LONG]</literal></entry>
                            <entry>Longitude at event</entry>
                        </row>
                        <row>
                            <entry><literal>[NICK_DEVID]</literal></entry>
                            <entry>Device ID and optional nick name of reporting tracker</entry>
                        </row>
                        <row>
                            <entry><literal>[HEADING]</literal></entry>
                            <entry>Heading as reported by tracker</entry>
                        </row>
                        <row>
                            <entry><literal>[SAT]</literal></entry>
                            <entry>Number of satellites used for position fix</entry>
                        </row>
                        <row>
                            <entry><literal>[VOLTAGE]</literal></entry>
                            <entry>Battery voltage (Voltage under 3.7V is considered low)</entry>
                        </row>
                        <row>
                            <entry><literal>[SERVERNAME]</literal></entry>
                            <entry>The name of the server</entry>
                        </row>
                        <row>
                            <entry><literal>[SERVERTIME]</literal></entry>
                            <entry>The time at the server</entry>
                        </row>
                        <row>
                            <entry><literal>[DISK_SIZE]</literal></entry>
                            <entry>Size of disk partition where the database is stored</entry>
                        </row>
                        <row>
                            <entry><literal>[DISK_USED]</literal></entry>
                            <entry>Used size of disk partition</entry>
                        </row>
                        <row>
                            <entry><literal>[DISK_PERCENT_USED]</literal></entry>
                            <entry>Used size in percent</entry>
                        </row>
                        <row>
                            <entry><literal>[DAEMONVERSION]</literal></entry>
                            <entry>Daemon version</entry>
                        </row>
                        <row>
                            <entry><literal>[NICK]</literal></entry>
                            <entry>Nick name if available, device ID otherwise</entry>
                        </row>
                        <row>
                            <entry><literal>[NICK_DEVID]</literal></entry>
                            <entry>Both nick name and device ID if available as "NICK (DEVID)"
                                otherwise just "DEVID" if nick not available</entry>
                        </row>
                        <row>
                            <entry><literal>[SYSTEM_LOADAVG]</literal></entry>
                            <entry>System load average string</entry>
                        </row>
                        <row>
                            <entry><literal>[APPROX_ADDRESS]</literal></entry>
                            <entry>The approximate street address corresponding to the
                                coordinates.</entry>
                        </row>
                        <row>
                            <entry namest="c1" nameend="c2"><emphasis role="italic"><emphasis
                                        role="bold">The following placeholders are only for the
                                            <filename>mail_event_img.html</filename>
                                        template</emphasis></emphasis></entry>
                        </row>
                        <row>
                            <entry><literal>[CID01]</literal></entry>
                            <entry>The HTML image id for the overview map</entry>
                        </row>
                        <row>
                            <entry><literal>[CID01]</literal></entry>
                            <entry>The HTML image id for the detailed map</entry>
                        </row>
                        <row>
                            <entry><literal>[IMG_WIDTH]</literal></entry>
                            <entry>The width of the map image</entry>
                        </row>
                        <row>
                            <entry><literal>[IMG_HEIGHT]</literal></entry>
                            <entry>The height of the map image</entry>
                        </row>
                        <row>
                            <entry><literal>[ZOOM_OVERVIEW]</literal></entry>
                            <entry>Zoom factor for overview map</entry>
                        </row>
                        <row>
                            <entry><literal>[ZOOM_DETAILED]</literal></entry>
                            <entry>Zoom factor for detailed map</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
        <para>To adjust the template just make a copy of the original templates as a backup and use
            your favourite editor to adjust the templates as requested. Please note that the name
            and/or the file endings can not be changed. The templates used are:</para>
        <para>
            <table>
                <title>Mail templates</title>
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="1.2*"/>
                    <colspec colname="c2" colnum="2" colwidth="1*"/>
                    <thead>
                        <row>
                            <entry>Template name</entry>
                            <entry>Usage</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry><filename>mail_event.html</filename></entry>
                            <entry>Used for all event mails</entry>
                        </row>
                        <row>
                            <entry><filename>mail_event.txt</filename></entry>
                            <entry/>
                        </row>
                        <row>
                            <entry><filename>mail_event_img.html</filename></entry>
                            <entry>Used for event mail with minimap</entry>
                        </row>
                        <row>
                            <entry><filename>mail_event_img.txt</filename></entry>
                            <entry/>
                        </row>
                        <row>
                            <entry><filename>mail_with_export_attachment.html</filename></entry>
                            <entry>Used to send exported database</entry>
                        </row>
                        <row>
                            <entry><filename>mail_with_export_attachment.txt</filename></entry>
                            <entry/>
                        </row>
                        <row>
                            <entry><filename>mail_lastloc.html</filename></entry>
                            <entry>Used for sending the last received location (<command>db
                                    mailpos</command>)</entry>
                        </row>
                        <row>
                            <entry><filename>mail_lastloc.txt</filename></entry>
                            <entry/>
                        </row>
                        <row>
                            <entry><filename>mail_tracker_conn,html</filename></entry>
                            <entry>Used for new tracker connection (if enabled)</entry>
                        </row>
                        <row>
                            <entry><filename>mail_tracker_conn.txt</filename></entry>
                            <entry/>
                        </row>
                        <row>
                            <entry><filename>mail_quotalimit.html</filename></entry>
                            <entry>Used to notify about whenGoogle API limit is exceeded</entry>
                        </row>
                        <row>
                            <entry><filename>mail_quotalimit.txt</filename></entry>
                            <entry/>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
        <para>
            <note>
                <para>Please remember that mail functionality requires you to adjust the parameters
                    in the <literal>[mail]</literal> section of the <filename>g7ctrl.conf</filename>
                    in accordance with your setup.</para>
            </note>
        </para>
        <para>
            <figure xml:id="fig.mail_event_img">
                <title>An example of the HTML event mail with the minimap included</title>
                <mediaobject>
                    <imageobject role="fo">
                        <imagedata fileref="event_mail_with_minimap_large.png" scalefit="1"
                            width="100%" contentwidth="100%"/>
                    </imageobject>
                    <imageobject role="html">
                        <imagedata fileref="event_mail_with_minimap_large.png" scalefit="1"
                            contentwidth="500px"/> 
                    </imageobject>
                </mediaobject>
            </figure>
        </para>
        <para>
            <note>
                <para>HTML mails use CSS to style the look &amp; feel. Unfortunately many email
                    client can only handle CSS as inline style and not in a separate CSS section
                    which makes the HTML templates quite verbose since the same style has to be
                    repeated at every applicable location.</para>
            </note>
        </para>    
    </section>
    <section xml:id="section.event-scripts">
        <title>Event-scripts</title>
        <para>Using an event scripts is a way to have the daemon execute a user specified action
            when triggered by an event from the device. All event scripts are stored in the static
            data directory (normally "<filename>/usr/share/g7ctrl/event_scripts/</filename>"). By
            default there are null actions for all events in a number of templates and hence the
            administrator has to decide if any and in thta case what should be done when certain
            events happen. Each event script is named according to the rule
                "<filename>&lt;event_number>_action.sh</filename>". So for example the action done
            when receiving event number 2 is "<filename>2_action.sh</filename>".</para>
        <para>
            <note>
                <para>By default a number of templates for the possible action scripts are supplied.
                    To enable action scripts you must copy the template to a new file with just the
                        "<literal>.sh</literal>" suffix. Event scripts are written as regular shell
                    scripts and requires knowledge of <acronym>GNU</acronym> command line Linux shell scripting. </para>
            </note>
        </para>
        <para>The events with the corresponding action scripts together with the related device
            command are:</para>
        <para>
            <table>
                <title>Device events</title>
                <tgroup cols="4">
                    <colspec colname="c1" colnum="1" colwidth="0.1*"/>
                    <colspec colname="newCol2" colnum="2" colwidth="0.4*"/>
                    <colspec colname="c2" colnum="3" colwidth="0.6*"/>
                    <colspec colname="newCol3" colnum="4" colwidth="0.4*"/>
                   
                    <thead>
                        <row>
                            <entry>Event</entry>
                            <entry>Script name</entry>
                            <entry>Description</entry>
                            <entry>Related device command</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>0</entry>
                            <entry><filename>0_action.sh</filename></entry>
                            <entry>Position data</entry>
                            <entry>GETLOCATION</entry>
                        </row>
                        <row>
                            <entry>1</entry>
                            <entry><filename>1_action.sh</filename></entry>
                            <entry>Logging data (location that has been stored in device
                                memory)</entry>
                            <entry>REC</entry>
                        </row>
                        <row>
                            <entry>2</entry>
                            <entry><filename>2_action.sh</filename></entry>
                            <entry>Track position data</entry>
                            <entry>TRACK</entry>
                        </row>
                        <row>
                            <entry>4</entry>
                            <entry><filename>4_action.sh</filename></entry>
                            <entry>Timer report</entry>
                            <entry>PSMT</entry>
                        </row>
                        <row>
                            <entry>34</entry>
                            <entry><filename>34_action.sh</filename></entry>
                            <entry>Wake Up Report</entry>
                            <entry>PSMT</entry>
                        </row>
                        <row>
                            <entry>37</entry>
                            <entry><filename>37_action.sh</filename></entry>
                            <entry>Enter Sleeping Report</entry>
                            <entry>PSMT</entry>
                        </row>
                        <row>
                            <entry>40</entry>
                            <entry><filename>40_action.sh</filename></entry>
                            <entry>Internal Battery Low Alert</entry>
                            <entry>LOWBATT</entry>
                        </row>
                        <row>
                            <entry>48</entry>
                            <entry><filename>48_action.sh</filename></entry>
                            <entry>Geo Fence Crossing Event</entry>
                            <entry>GFEN</entry>
                        </row>
                        <row>
                            <entry>100</entry>
                            <entry><filename>100_action.sh</filename></entry>
                            <entry>Unit Detaching Report</entry>
                            <entry>SETRA</entry>
                        </row>
                        <row>
                            <entry>-</entry>
                            <entry><filename>tracker_conn.sh</filename></entry>
                            <entry>Run (if enabled in config) when a new tracker connection is
                                detected-</entry>
                            <entry>-</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
        <para>The scripts will receive the <literal>deviceid</literal>, <literal>datetime</literal>,
                <literal>latitude</literal> and <literal>longitude</literal> as command line
            arguments to be used in the scripts. The supplied script templates does not perform any
            action but contains a skeleton to make it easy to adapt and also shows how to make use
            of the supplied arguments.</para>
        <para>One interesting application can be to have an event trigger a sound to be played as is
            shown in in the <filename>100_action.sh</filename> script although it is commented out
            since it assumes the existence of a <acronym>MP3</acronym> audio file and a command line
            argument to play it. </para>
        <para>As an example the following listing shows the supplied template for
                <filename>"0_action.sh.template"</filename></para>
        <para><programlisting><xi:include href="../../src/etc/event-scripts/0_action.sh.template" parse="text"
            xmlns:xi="http://www.w3.org/2001/XInclude"/></programlisting></para>
        <para>In the supplied template it is clearly marked where you are supposed to enter you
            script lines. In order to play a warning sound on your computer whenever for example the
            low battery event is happening assuming you have an appropriate sound file called
                "<filename>warning-signal.mp3</filename>" just add the following lines to
                <filename>40_action.sh</filename> (copied from
                <filename>40_action.sh.template</filename></para>
        <para>
            <screen>mpg123 warning-signal.mp3 > /dev/null 2>&amp;1 &amp;</screen>
        </para>
        <para>Remember that if you have mail on event enabled (See <xref
                linkend="section.mail-templates"/>) then that event will also generate an
            automatic mail notification.</para>
        <para>
            <note>
                <para><emphasis role="bold">TECHNICAL:</emphasis> Each script is run in its own
                    thread (from version 2.1.4 and forward) so there is no need to consider limiting
                    the running time of the script.</para>
            </note>
        </para>
    </section>   
</appendix>
